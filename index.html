<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Check-in Nh√¢n vi√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: auto;
      padding: 20px;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
    }
    #form-checkin {
      display: none;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
    #resetBtn {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      display: none;
    }
  </style>
</head>
<body>
  <h2>‚úÖ Check-in Nh√¢n vi√™n</h2>
  <p id="status">üìç ƒêang ki·ªÉm tra v·ªã tr√≠ GPS...</p>

  <form id="form-checkin"
        action="https://script.google.com/macros/s/AKfycbwgCQClkLyThgrqUozk43jD9pVBavphOE4uV-64L_LBeJ912ZzldR5c7bJL3AoQd9d6/exec"
        method="POST"
        target="hiddenFrame"
        onsubmit="handleSubmit()">
    <input type="text" name="manv" id="manv" placeholder="M√£ nh√¢n vi√™n" required />
    <input type="text" name="hoten" id="hoten" placeholder="H·ªç t√™n" required />
    
    <select name="phong" id="phong" required>
      <option value="">-- Ch·ªçn ph√≤ng ban --</option>
      <option value="Ph√≤ng Ph√°t Tri·ªÉn">Ph√≤ng Ph√°t Tri·ªÉn</option>
      <option value="Ph√≤ng Ki·ªÉm Th·ª≠">Ph√≤ng Ki·ªÉm Th·ª≠</option>
      <option value="Ph√≤ng Gi·∫£i Ph√°p">Ph√≤ng Gi·∫£i Ph√°p</option>
      <option value="Ph√≤ng QTDA">Ph√≤ng QTDA</option>
      <option value="Ph√≤ng KHTH">Ph√≤ng KHTH</option>
      <option value="Ph√≤ng S·∫£n Ph·∫©m">Ph√≤ng S·∫£n Ph·∫©m</option>
      <option value="Ph√≤ng TVGP KHDN">Ph√≤ng TVGP KHDN</option>
      <option value="Ph√≤ng KHDN">Ph√≤ng KHDN</option>
      <option value="Ph√≤ng TVGP KHHCM">Ph√≤ng TVGP KHHCM</option>
      <option value="Ph√≤ng KH HCM">Ph√≤ng KH HCM</option>
      <option value="Ph√≤ng H·ªó Tr·ª£">Ph√≤ng H·ªó Tr·ª£</option>
      <option value="Ph√≤ng KH YT-GD">Ph√≤ng KH YT-GD</option>
      <option value="Ph√≤ng KH SXTD ">Ph√≤ng KH SXTD</option>
    </select>

    <!-- ‚úÖ √î ·∫©n ƒë·ªÉ g·ª≠i s·ªë l·∫ßn check-in l·∫°i -->
    <input type="hidden" name="solanreset" id="solanreset" value="0" />

    <button type="submit">G·ª≠i Check-in</button>
  </form>

  <iframe name="hiddenFrame" style="display:none;"></iframe>

  <p id="result"></p>
  <button id="resetBtn" onclick="resetCheckin()">üîÑ Check-in l·∫°i</button>

  <script>
    const latTarget = 10.7774507;
    const lngTarget = 106.6801610;
    const allowedDistance = 80;

    const statusEl = document.getElementById("status");
    const formEl = document.getElementById("form-checkin");
    const resultEl = document.getElementById("result");
    const resetBtn = document.getElementById("resetBtn");

    // ‚úÖ L·∫•y s·ªë l·∫ßn reset, m·∫∑c ƒë·ªãnh 0 n·∫øu ch∆∞a t·ª´ng reset
    let resetCount = Number(localStorage.getItem("resetCount")) || 0;

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    if (localStorage.getItem("hasCheckedIn") === "true") {
      statusEl.textContent = "‚úÖ B·∫°n ƒë√£ check-in tr√™n thi·∫øt b·ªã n√†y.";
      resetBtn.style.display = "block";
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const d = getDistance(pos.coords.latitude, pos.coords.longitude, latTarget, lngTarget);
        if (d <= allowedDistance) {
          statusEl.textContent = `üìç Trong ph·∫°m vi ${d.toFixed(1)}‚ÄØm ‚Äì m·ªùi b·∫°n nh·∫≠p th√¥ng tin.`;
          formEl.style.display = "block";
        } else {
          statusEl.textContent = `‚ùå B·∫°n c√°ch ${d.toFixed(1)}‚ÄØm ‚Äì vui l√≤ng ƒë·∫øn g·∫ßn ƒë·ªãa ƒëi·ªÉm check-in (‚â§ ${allowedDistance}m).`;
        }
      }, err => {
        statusEl.textContent = `‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: ${err.message}`;
      }, { enableHighAccuracy: true, timeout: 10000 });
    } else {
      statusEl.textContent = "‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
    }

    function handleSubmit() {
      localStorage.setItem("hasCheckedIn", "true");

      // ‚úÖ G·ª≠i ƒë√∫ng s·ªë l·∫ßn reset hi·ªán t·∫°i
      document.getElementById("solanreset").value = resetCount.toString();

      const name = document.getElementById("hoten").value;
      const time = new Date().toLocaleString("vi-VN");
      formEl.style.display = "none";
      resultEl.innerHTML = `‚úÖ C·∫£m ∆°n ${name}, b·∫°n ƒë√£ check-in l√∫c ${time}`;
      resetBtn.style.display = "block";
    }

    function resetCheckin() {
      resetCount++;
      localStorage.setItem("resetCount", resetCount.toString());
      localStorage.removeItem("hasCheckedIn");
      location.reload();
    }
  </script>
</body>
</html>
