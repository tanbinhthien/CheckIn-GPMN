<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Check-in Nh√¢n vi√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 480px; margin: auto; padding: 20px; }
    input, button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; }
    #form-checkin { display: none; }
    #result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>‚úÖ Check-in Nh√¢n vi√™n</h2>
  <p id="status">üìç ƒêang ki·ªÉm tra v·ªã tr√≠ GPS...</p>

  <form id="form-checkin"
        action="https://script.google.com/macros/s/AKfycbwFqpxDVGCTAtR2bdiKbnfulzMn5UsvHD9AMnH8LEITIqlcBKhd9dKqVM799jM1h_dd/exec"
        method="POST"
        target="hiddenFrame"
        onsubmit="handleSubmit()">
    <input type="text" name="manv" id="manv" placeholder="M√£ nh√¢n vi√™n" required />
    <input type="text" name="hoten" id="hoten" placeholder="H·ªç t√™n" required />
    <input type="text" name="phong" id="phong" placeholder="Ph√≤ng ban" required />
    <button type="submit">G·ª≠i Check-in</button>
  </form>

  <iframe name="hiddenFrame" style="display:none;"></iframe>

  <p id="result"></p>

  <script>
    const latTarget = 10.657650849130794;
    const lngTarget = 106.61933287072665;
    const allowedDistance = 100; // m√©t

    const statusEl = document.getElementById("status");
    const formEl = document.getElementById("form-checkin");
    const resultEl = document.getElementById("result");

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    if (localStorage.getItem("hasCheckedIn") === "true") {
      statusEl.textContent = "‚úÖ B·∫°n ƒë√£ check-in tr√™n thi·∫øt b·ªã n√†y.";
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const d = getDistance(pos.coords.latitude, pos.coords.longitude, latTarget, lngTarget);
        if (d <= allowedDistance) {
          statusEl.textContent = `üìç Trong ph·∫°m vi ${d.toFixed(1)}‚ÄØm ‚Äì m·ªùi b·∫°n nh·∫≠p th√¥ng tin.`;
          formEl.style.display = "block";
        } else {
          statusEl.textContent = `‚ùå B·∫°n c√°ch ${d.toFixed(1)}‚ÄØm ‚Äì vui l√≤ng ƒë·∫øn g·∫ßn ƒë·ªãa ƒëi·ªÉm check-in (‚â§ ${allowedDistance}m).`;
        }
      }, err => {
        statusEl.textContent = `‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: ${err.message}`;
      }, { enableHighAccuracy: true, timeout: 10000 });
    } else {
      statusEl.textContent = "‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
    }

    function handleSubmit() {
      localStorage.setItem("hasCheckedIn", "true");
      const name = document.getElementById("hoten").value;
      const time = new Date().toLocaleString("vi-VN");
      formEl.style.display = "none";
      resultEl.innerHTML = `‚úÖ C·∫£m ∆°n ${name}, b·∫°n ƒë√£ check-in l√∫c ${time}`;
    }
  </script>
</body>
</html>
