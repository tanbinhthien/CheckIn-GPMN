<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CHECK-IN S·ª∞ KI·ªÜN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f6fa;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 480px;
      margin: auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
    }
    h2 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 24px;
      text-transform: uppercase;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #333;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #005fa3;
    }
    #resetBtn {
      background: #eee;
      color: #333;
      margin-top: 8px;
      border: 1px solid #bbb;
    }
    #status {
      text-align: center;
      margin-bottom: 16px;
      font-weight: bold;
    }
    #result {
      text-align: center;
      margin-top: 16px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>CHECK-IN S·ª∞ KI·ªÜN</h2>
    <p id="status">üìç ƒêang ki·ªÉm tra v·ªã tr√≠ GPS...</p>

    <form id="form-checkin"
          action="https://script.google.com/macros/s/AKfycbxl_OZWXg1RsPYjMXRv0I3-rcAOxtuJIFXOUI8wOOeL_xAD0_OjYxIU2JmqJYXCeHXa/exec"
          method="POST"
          target="hiddenFrame">

      <label for="manv">M√£ nh√¢n vi√™n</label>
      <input type="text" name="manv" id="manv" placeholder="VD: NV123" required />

      <label for="hoten">H·ªç v√† t√™n</label>
      <input type="text" name="hoten" id="hoten" placeholder="Nguy·ªÖn VƒÉn A" required />

      <label for="phong">Ph√≤ng ban</label>
      <select name="phong" id="phong" required>
        <option value="">-- Ch·ªçn ph√≤ng ban --</option>
        <option value="Ph√≤ng Ph√°t Tri·ªÉn">Ph√≤ng Ph√°t Tri·ªÉn</option>
        <option value="Ph√≤ng Ki·ªÉm Th·ª≠">Ph√≤ng Ki·ªÉm Th·ª≠</option>
        <option value="Ph√≤ng Gi·∫£i Ph√°p">Ph√≤ng Gi·∫£i Ph√°p</option>
        <option value="Ph√≤ng QTDA">Ph√≤ng QTDA</option>
        <option value="Ph√≤ng S·∫£n Ph·∫©m">Ph√≤ng S·∫£n Ph·∫©m</option>
        <option value="Ph√≤ng KHTH">Ph√≤ng KHTH</option>
        <option value="Ph√≤ng TVGP KHDN">Ph√≤ng TVGP KHDN</option>
        <option value="Ph√≤ng KHDN">Ph√≤ng KHDN</option>
        <option value="Ph√≤ng TVGP KHHCM">Ph√≤ng TVGP KHHCM</option>
        <option value="Ph√≤ng KH HCM">Ph√≤ng KH HCM</option>
        <option value="Ph√≤ng H·ªó Tr·ª£">Ph√≤ng H·ªó Tr·ª£</option>
        <option value="Ph√≤ng KH YT-GD">Ph√≤ng KH YT-GD</option>
        <option value="Ph√≤ng KH SXTD ">Ph√≤ng KH SXTD</option>
      </select>

      <input type="hidden" name="solanreset" id="solanreset" value="0" />

      <button type="submit">‚úÖ G·ª≠i Check-in</button>
    </form>

    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <p id="result"></p>
    <button id="resetBtn" onclick="resetCheckin()" style="display: none;">üîÑ Check-in l·∫°i</button>
  </div>

<script>
  const latTarget = 10.7774507;
  const lngTarget = 106.6801610;
  const allowedDistance = 80;

  const statusEl = document.getElementById("status");
  const formEl = document.getElementById("form-checkin");
  const resultEl = document.getElementById("result");
  const resetBtn = document.getElementById("resetBtn");

  let resetCount = Number(localStorage.getItem("resetCount")) || 0;

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  if (localStorage.getItem("hasCheckedIn") === "true") {
    statusEl.textContent = "‚úÖ B·∫°n ƒë√£ check-in tr√™n thi·∫øt b·ªã n√†y.";
    resetBtn.style.display = "block";
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const d = getDistance(pos.coords.latitude, pos.coords.longitude, latTarget, lngTarget);
      if (d <= allowedDistance) {
        statusEl.textContent = `üìç Trong ph·∫°m vi ${d.toFixed(1)}‚ÄØm ‚Äì m·ªùi b·∫°n nh·∫≠p th√¥ng tin.`;
        formEl.style.display = "block";
      } else {
        statusEl.textContent = `‚ùå B·∫°n c√°ch ${d.toFixed(1)}‚ÄØm ‚Äì vui l√≤ng ƒë·∫øn g·∫ßn ƒë·ªãa ƒëi·ªÉm check-in (‚â§ ${allowedDistance}m).`;
      }
    }, err => {
      statusEl.textContent = `‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: ${err.message}`;
    }, { enableHighAccuracy: true, timeout: 10000 });
  } else {
    statusEl.textContent = "‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
  }

  function handleSubmit() {
    if (resetCount > 3) {
      alert("‚ùå B·∫°n ƒë√£ v∆∞·ª£t qu√° s·ªë l·∫ßn check-in l·∫°i (t·ªëi ƒëa 3 l·∫ßn). Vui l√≤ng li√™n h·ªá ban t·ªï ch·ª©c.");
      return false; // Ch·∫∑n submit
    }

    localStorage.setItem("hasCheckedIn", "true");
    document.getElementById("solanreset").value = resetCount.toString();

    const name = document.getElementById("hoten").value;
    const time = new Date().toLocaleString("vi-VN");

    formEl.style.display = "none";
    resultEl.innerHTML = `‚úÖ C·∫£m ∆°n ${name}, b·∫°n ƒë√£ check-in l√∫c ${time}`;
    resetBtn.style.display = "block";

    return true; // Cho ph√©p submit
  }

  function resetCheckin() {
    resetCount++;
    localStorage.setItem("resetCount", resetCount.toString());
    localStorage.removeItem("hasCheckedIn");
    location.reload();
  }
  
  document.getElementById("form-checkin").addEventListener("submit", function(e) {
  if (!handleSubmit()) {
    e.preventDefault(); // NgƒÉn g·ª≠i form
  }
  });
</script>

</body>
</html>
