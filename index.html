<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Check-in NhÃ¢n viÃªn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 480px; margin: auto; padding: 20px; }
    input, button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; }
    #form-checkin { display: none; }
    #result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>âœ… Check-in NhÃ¢n viÃªn</h2>
  <p id="status">ğŸ“ Äang kiá»ƒm tra vá»‹ trÃ­ GPS...</p>

  <form id="form-checkin">
    <input type="text" id="manv" placeholder="MÃ£ nhÃ¢n viÃªn" required />
    <input type="text" id="hoten" placeholder="Há» tÃªn" required />
    <input type="text" id="phong" placeholder="PhÃ²ng ban" required />
    <button type="submit">Gá»­i Check-in</button>
  </form>

  <p id="result"></p>

  <script>
    const latTarget = 10.657650849130794; // ğŸ” Thay báº±ng tá»a Ä‘á»™ vá»‹ trÃ­ thá»±c táº¿
    const lngTarget =  106.61933287072665;  // ğŸ” Thay báº±ng tá»a Ä‘á»™ vá»‹ trÃ­ thá»±c táº¿
    const allowedDistance = 100; // mÃ©t

    const statusEl = document.getElementById("status");
    const formEl = document.getElementById("form-checkin");
    const resultEl = document.getElementById("result");

    // TÃ­nh khoáº£ng cÃ¡ch giá»¯a hai tá»a Ä‘á»™ GPS
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï†/2) ** 2 +
                Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // mÃ©t
    }

    // Kiá»ƒm tra Ä‘Ã£ check-in chÆ°a
    if (localStorage.getItem("hasCheckedIn") === "true") {
      statusEl.textContent = "âœ… Báº¡n Ä‘Ã£ check-in trÃªn thiáº¿t bá»‹ nÃ y.";
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const d = getDistance(pos.coords.latitude, pos.coords.longitude, latTarget, lngTarget);
        if (d <= allowedDistance) {
          statusEl.textContent = `ğŸ“ Trong pháº¡m vi ${d.toFixed(1)}â€¯m â€“ má»i báº¡n nháº­p thÃ´ng tin.`;
          formEl.style.display = "block";
        } else {
          statusEl.textContent = `âŒ Báº¡n cÃ¡ch ${d.toFixed(1)}â€¯m â€“ vui lÃ²ng Ä‘áº¿n gáº§n Ä‘á»‹a Ä‘iá»ƒm check-in (â‰¤ ${allowedDistance}m).`;
        }
      }, err => {
        statusEl.textContent = `âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­: ${err.message}`;
      }, { enableHighAccuracy: true, timeout: 10000 });
    } else {
      statusEl.textContent = "âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹ GPS.";
    }

    // Gá»­i dá»¯ liá»‡u
    formEl.addEventListener("submit", e => {
      e.preventDefault();
      const data = {
        manv: document.getElementById("manv").value.trim(),
        hoten: document.getElementById("hoten").value.trim(),
        phong: document.getElementById("phong").value.trim(),
        time: new Date().toLocaleString("vi-VN")
      };

      fetch("https://script.google.com/macros/s/AKfycbxtu50930wIWopJYux1LA9O0YyAIk2hOLPV2pzRzZyYKOrkvVUCQKy7pkxII0oYVI2n/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (res.ok) {
          localStorage.setItem("hasCheckedIn", "true");
          formEl.style.display = "none";
          resultEl.innerHTML = `âœ… Cáº£m Æ¡n ${data.hoten}, báº¡n Ä‘Ã£ check-in lÃºc ${data.time}`;
        } else {
          throw new Error("KhÃ´ng gá»­i Ä‘Æ°á»£c dá»¯ liá»‡u.");
        }
      })
      .catch(err => {
        resultEl.textContent = `âŒ Lá»—i gá»­i dá»¯ liá»‡u: ${err.message}`;
      });
    });
  </script>
</body>
</html>
